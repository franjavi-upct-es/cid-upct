---
title: "Análisis Estadístico Multivariante\\ Control 1 de Prácticas"
author: "Francisco Javier Mercader Martínez"
date: "27/02/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("readxl")
datos <- read_xlsx("data/zumos_B.xlsx")
```

# Problema 1
1) Realiza un diagrama de caja y biggotes del problema e indica si hay atípicos (no elimines ninguno). Realiza los diagramas de dispersión por pares de variables y comenta los resultados más relevantes.

```{r}
boxplot(datos)
plot(datos)
```

En los diagramas de dispersión por pares Podemos ver que las variables X2 y X3 están fuertemente relacionadas. El resto de variables están menos relacionadas pero se puede apreciar que su relación es alta

2)¿Podemos suponer que nuestra variable respuesta es Normal? Realiza un test hipótesis y comenta el resutlado.

Por el planteamiento del problema he deducido que la variable respuesta es `zumo`.
```{r}
shapiro.test(datos$zumo)

qqnorm(datos$zumo)
qqline(datos$zumo)
```
Realizando la prueba de Shapiro se puede ver que `p-value`tiene un valor bastante alto por lo que deduimos que se trata de una variable normalizada.

3) Realiza la familia de transformaciones de Box-Cox, variando el expoenente lambda en (-5,5) para confirmar que sería adecuado no tansformar la variable respuesta

```{r}
library("MASS")
boxcox(lm(zumo ~ ., data = datos), lambda = seq(-5,5,1/10))
```
4) Calcula la matriz de corrrelaciones de todas las varaibles del problema. ¿Qué regresores del modelo presentan una más estrecha relación lineal entre sí? ¿Cuál es la primera variable del modelo?

```{r}
cor(datos)

# Las varaibles con más relación son X2 y X3 (0.85309117) y seguidos por 
# zumo y X4 (0.8118917408)
```
5) 
```{r}
modelo_completo <- lm(zumo ~ ., data=datos)
modelo_cte <- lm(zumo ~ 1, data=datos)

modelo_backward <- step(modelo_completo, direction = "backward")
modelo_forward <- step(modelo_cte, direction = "forward", scope = formula(modelo_completo))
modelo_stepwise <- step(modelo_cte, direction = "both", scope = formula(modelo_completo))

modelo_backward$coefficients
modelo_forward$coefficients
```
En ambos modelos se quedarían las variable `X2` y `X4`.

6)
```{r}
# Propondremos un único modelo de regresión
modelo_final <- lm(zumo ~ X2 + X4, data = datos)

summary(modelo_final)
```
El valor del coeficiente de determinación es 0.9481 lo que indica que hay casi un 95% de la varaibilidad del zumo que se elabora.
7)
```{r}
modelo_final <- lm(zumo ~ X2 + X4, data = datos)

confint(modelo_final, level=0.95)
```
Voy a tener que descartar la ecuación de relación ya que $\theta_2=0.5$ se queda baja.

8) 
```{r}
# Normalidad de los residuos
shapiro.test(modelo_final$residuals)
qqnorm(modelo_final$residuals)
qqline(modelo_final$residuals)

# Hipótesis de Homocedasticidad
plot(modelo_final$fitted.values, modelo_final$residuals)

# Hipótesis de Independencia
ts.plot(modelo_final$residuals)

library(lmtest)
dwtest(modelo_final, alternative = "two.sided")

# Comprobamos si existe multicolinealidad en los regresores.
library(rms)
vif(modelo_final)
vif(modelo_completo)

# Lo último es comprobar que no hay observaciones influyentes, para ello calcularé
# la distancia de Cook para cada observación.

cook <- cooks.distance(modelo_final)
plot(cook)
```

9)
```{r}
nuevos <- data.frame(X2 = 500, X4 = 950)
predict(modelo_final, newdata = nuevos, interval = 'prediction', level = 0.95)
predict(modelo_final, newdata = nuevos, interval = "confidence", level = 0.95)
```
Con los datos obtenidos podemos confirmar que la cantidad de zumo obtenida después del proceso será superior a 1300 litros.
Se espera que la cantidad media de zumo elaborada sea de 1313.818 litros de zumo.

10)
```{r}
nuevos <- data.frame(X2 = 500, X4 = 300)
predict(modelo_final, newdata = nuevos, interval = 'prediction', level = 0.95)
predict(modelo_final, newdata = nuevos, interval = "confidence", level = 0.95)
```
Con los datos obtenidos podemos descartar que la cantidad de zumo obtenida sea superior a 1300 litros, de hecho es todo lo contrario, ya que se espera que la producción media esté por 854.789 litros de zumo

# Problema 2
```{r}
V <- matrix(NA, 3, 3)
V[1,] <- c(2,1,2)
V[2,] <- c(1,4,2)
V[3,] <- c(2,2,4)

mu <- c(10, 30, 20)
```

1)
```{r}
library(mvtnorm)
```
  a) 
```{r}
dmvnorm(x=c(20, 20, 20), mean = mu, sigma = V)
```
  b)  
```{r}

```

  c) 
```{r}
dmvnorm(x=c(12, 32, 22), mean = mu, sigma = V)
```
2) 
```{r}
set.seed(456)
d <- mvrnorm(n=1000, mu=mu, Sigma = V)
```
  a) 
```{r}
data.frame(mu, V)

data.frame(colMeans(d), cov(d))
```
  
Se pueden apreciar diferencias de decimales,lo que indica que las medias teóricas están redondeadas y las medias muestrales dan datos mucho más precisos.

  b)
```{r}
library(mvnormtest)
mshapiro.test(t(d))
```
Con los datos obtenidos confirmo que los datos provienen de una distribución Normal.

  c)
```{r}
dM1 <- mahalanobis(d, center = mu, cov = V)

dM2 <- mahalanobis(d, center = colMeans(d), cov = cov(d))

max(dM1)

max(dM2)
```
  
