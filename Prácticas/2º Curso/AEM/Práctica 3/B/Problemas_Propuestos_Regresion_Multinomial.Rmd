---
title: "Problemas Propuesto Regresión Multinomial"
author: "Francisco Javier Mercader Martínez"
output: 
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: fvextra
header-includes:
- \usepackage{fvextra}
- \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines, commandchars=\\\{\}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Problema 1

El dichero **iris** de R, contiene los datos correspondientes de los pétalos y sépalos de tres variedades de flor de iris (setosa, virginica y versicolor).

Se desea realizar un análisis de Regresión Multinomial con el fin de predecir la variedad de la flor en función de las magnitudes de sus pétalos y sépalos. Se pide:

1)  Recuperar los datos y realizar un estudio descriptivo previo atendiendo a nuestro objetivo.

```{r}
iris <- iris
summary(iris)

library(tidyverse)

iris %>%
ggplot(aes(y = Sepal.Length, x = Species)) + geom_boxplot(aes(color = Species)) 

plot(iris)
```

2)  Dividir el conjunto de datos en entrenamiento y prueba (70% entrenamiento, 30% prueba). Tomar semilla 123.

```{r}
set.seed(123)

split <- sample(1:nrow(iris), 0.7 * nrow(iris))

# Conjunto de entrenamiento
train_data <- iris[split, ]

# Conjunto de prueba
test_data <- iris[-split, ]
```

3)  Con los datos de entrenamiento, obtener el modelo ajustado de Regresión Multinomial usando todos los predictores.

```{r}
library(nnet)
iris$Species <- relevel(iris$Species, ref = "setosa")
modelo_ajustado <- multinom(Species ~ ., data = train_data)

summary(modelo_ajustado)
```

4)  Con los datos de entrenamiento, aplicar los métodos de selección de regresores para comprobar si el modelo completo es reducible.

```{r}
modelo_nulo <- multinom(Species ~ 1, data = train_data)
modelo_backward <- step(modelo_ajustado, direction = "backward")
modelo_forward <- step(modelo_nulo, direction = "forward", scope = formula(modelo_ajustado))
modelo_stepwise <- step(modelo_nulo, direction = "both", scope = formula(modelo_ajustado))
```

5)  Con el modelo resultante del apartado anterior, obtener medidas de bondad del ajuste e indicar si el modelo es significativo.

```{r}
# Bondad del ajuste
paste("Bondad del ajuste =", modelo_ajustado$AIC)

# Significación del modelo
diferencia_desvianza <- modelo_nulo$deviance - modelo_ajustado$deviance

df_nulo <- length(iris$Species) - 1
df_ajustado <- length(iris$Species) - length(modelo_ajustado$coefnames) - 1

grados_libertad <- df_nulo - df_ajustado

p_valor <- pchisq(diferencia_desvianza, df = grados_libertad, lower.tail = FALSE)

p_valor
```
El resultado de `p-valor` permite concluir que el modelo completo es significativo

6)  Veamos ahora el problema de Regresión Multinomial como un problema de clasificación. Obtener la clase predicha para los datos del conjunto de prueba.

```{r}
species_predict <- predict(modelo_ajustado, newdata = iris, "class")
iris_predict <- cbind(iris, species_predict)
```

7)  Obtener la matriz de confusión para el conjunto de prueba y medir la eficiencia del clasificador con el "accuracy" (número de aciertos en la clasificación dividido entre número de datos totales).

```{r}
matriz_confusion <- table(iris_predict$Species, iris_predict$species_predict,
                          dnn = c("real", "predicho"))
matriz_confusion

accuracy <- sum(diag(matriz_confusion)) / sum(matriz_confusion)
accuracy
```

