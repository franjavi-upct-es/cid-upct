---
title: "Práctica 5: Modelos de series con exógenas"
author: "Francisco Javier Mercader Martínez"
# date: " "
output:
  pdf_document: default
  # html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


**COMPLETAR PRÁCTICA 5: MODELOS DE SERIES TEMPORALES CON VARIABLES EXÓGENAS**

PROCESOS ESTOCÁSTICOS Y SERIES TEMPORALES

GRADO EN CIENCIA E INGENIERÍA DE DATOS


# 1. Modelos de Regresión para series temporales 


## 1.1. Ajuste de un modelo de Regresión Lineal para la serie log(AirPassengers)

En esta sección trabajaremos con la serie transformada log(AirPassengers).

```{r}
plot(log(AirPassengers))
```

Vamos a estimar un modelo de regresión lineal múltiple para explicar el comportamiento de la serie en función de los predictores (variables exógenas) "tiempo" y "dummy estacionales". 


### A) Forma 1: Ajuste RLM usando la función lm()


```{r}
library(forecast)
```

Definimos los predictores:

```{r}
tiempo <- time(log(AirPassengers)) # predictor tiempo
estacional.dummy <- seasonaldummy(log(AirPassengers)) # predictores dummy estacionales
```

Ajustamos el modelo RLM:

```{r}
lm_logdatos <- lm(log(AirPassengers) ~ tiempo + estacional.dummy)
summary(lm_logdatos)
```

Comportamiento de los residuos del modelo:

```{r}
plot(residuals(lm_logdatos)) # gráfico residuos

par(mfrow = c(1, 2))
acf(residuals(lm_logdatos)) # correlograma simple residuos
pacf(residuals(lm_logdatos)) # correlogerama parcial resiudos
```


**¿Y si usamos términos de Fourier en lugar de dummy estacionales?**

Podemos crear manualmente los predictores correspondientes a las series de Fourier:

```{r}
# Escribir bloque de código
n <- length(log(AirPassengers))
t <- 1:n
s1 <- sin(2 * pi * t / 12)
c1 <- cos(2 + pi * t / 12)
s2 <- sin(4 * pi * t / 12)
c2 <- cos(4 * pi * t / 12)
```

Podemos crear automáticamente los predictores series de Fourier para distintos valores de K:

```{r}
# Para K = 6 = L/2
fourier_terms_k6 <- fourier(log(AirPassengers), K = 6)
head(fourier_terms_k6)
```

Ajustamos el modelo RLM:

```{r}
lm_logdatos_Fourier <- lm(log(AirPassengers) ~ tiempo + fourier_terms_k6)
summary(lm_logdatos_Fourier)
```

Comportamiento de los residuos del modelo:

```{r}
plot(residuals(lm_logdatos_Fourier)) # gráfico residuos

par(mfrow = c(1, 2))
acf(residuals(lm_logdatos_Fourier)) # correlograma simple residuos
pacf(residuals(lm_logdatos_Fourier)) # correlogerama parcial resiudos
```

### B) Ajuste RLM usando la función tslm()


```{r}
tslm_logdatos <- tslm(log(AirPassengers) ~ trend + season)
summary(tslm_logdatos)
```
Comportamiento de los residuos del modelo:

```{r}
plot(residuals(tslm_logdatos)) # gráfico residuos

par(mfrow = c(1, 2))
acf(residuals(tslm_logdatos)) # correlograma simple residuos
pacf(residuals(tslm_logdatos)) # correlogerama parcial resiudos
```

Representamos la serie original y las predicciones a 3 años vista:

```{r}
plot(forecast(tslm_logdatos, h = 36))
```

**¿Y si usamos términos de Fourier en lugar de dummy estacionales?** 

Para $K=1$:

```{r, fig.align="center", out.width = '70%'}
tslm_logdatos_FourierK1 <- tslm(log(AirPassengers) ~ trend + fourier(log(AirPassengers), K = 1))

summary(tslm_logdatos_FourierK1)

plot(forecast(tslm_logdatos_FourierK1, newdata = data.frame(fourier(log(AirPassengers), K = 1, h = 36))))
```

Para $K=6$ obtenemos:

```{r}
# Escribir bloque de código
tslm_logdatos_FourierK6 <- tslm(log(AirPassengers) ~ trend + fourier(log(AirPassengers), K = 6))

summary(tslm_logdatos_FourierK6)

plot(forecast(tslm_logdatos_FourierK6, newdata = data.frame(fourier(log(AirPassengers), K = 6, h = 36))))
```
Comportamiento de los residuos del modelo:

```{r}
# Comportamiento de los residuos del modelo:
plot(residuals(tslm_logdatos_FourierK6)) # gráfico residuos

par(mfrow = c(1, 2))
acf(residuals(tslm_logdatos_FourierK6)) # correlograma simple residuos
pacf(residuals(tslm_logdatos_FourierK6)) # correlograma parcial residuos
```



## 1.2. Ajuste de un modelo de Regresión (no-lineal) para la serie AirPassengers

Ahora queremos modelizar la serie AirPassengers y no su logaritmo.

ESCENARIO 1: Tomamos exponenciales sobre los resultados que obtuvimos al analizar log(AirPassengers)

```{r}
plot(AirPassengers, xlim = c(1949, 1964), ylim = c(100, 900))
lines(exp(forecast(tslm_logdatos, h = 36)$fitted), col = "blue")
lines(exp(forecast(tslm_logdatos, h = 36)$mean), col = "red")
```


ESCENARIO 2: Ajuste de un modelo no-lineal para AirPassengers, que incluye interacciones entre tendencia y estacionalidad.


```{r}
tslm_datos <- tslm(AirPassengers ~ trend * season)
summary(tslm_datos)
plot(forecast(tslm_datos, h = 36))
```
Comportamiento de los residuos del modelo:

```{r}
plot(residuals(tslm_datos)) # gráfico residuos

par(mfrow = c(1, 2))
acf(residuals(tslm_datos)) # correlograma simple residuos
pacf(residuals(tslm_datos)) # correlograma parcial residuos
```

Comparación de predicciones en los dos escenarios:

```{r}
plot(AirPassengers, xlim = c(1949, 1964), ylim = c(100, 900), lwd = 2)
lines(exp(forecast(tslm_logdatos, h = 36)$fitted), col = "red")
lines(exp(forecast(tslm_logdatos, h = 36)$mean), col = "red")
lines(forecast(tslm_datos, h = 36)$fitted, col = "limegreen")
lines(forecast(tslm_datos, h = 36)$mean, col = "limegreen")
```

Intervalos de predicción:

```{r}
pred_log <- forecast(tslm_logdatos, h = 36)
pred_datos <- forecast(tslm_datos, h = 36)
```


**¿Y si usamos términos de Fourier en lugar de dummy estacionales?** 

```{r}
# Modelo con Fourier K=6 para AirPassengers (sin logaritmo)
tslm_datos_Fourier <- tslm(AirPassengers ~ trend * fourier(AirPassengers, K = 6))
summary(tslm_datos_Fourier)

# Predicción
fourier_futuro <- fourier(AirPassengers, K = 6, h = 36)
plot(forecast(tslm_datos_Fourier, newdata = data.frame(fourier_futuro)))
```

Comportamiento de los residuos

```{r}
plot(residuals(tslm_datos_Fourier)) # gráfico residuos

par(mfrow = c(1, 2))
acf(residuals(tslm_datos_Fourier)) # correlograma simple residuos
pacf(residuals(tslm_datos_Fourier)) # correlograma parcial residuos
```

# 2. Modelos de Regresión Dinámica para series temporales 


**Forma 1:** Ajuste de regresión y ARIMA conjunto.

**Forma 2:** Ajuste de regresión y ajuste ARIMA de los residuos por separado.


## 2.1. Ajuste de regresión y ARIMA conjunto.

COMPLETAR

```{r}
# Crear variables exógenas: tendencia y términos de Fourier
xreg_train <- cbind(
  trend = 1:length(log(AirPassengers)),
  fourier(log(AirPassengers), K = 6)
)

# Ajuste conjunto regresión + ARIMA
modelo_dinamico <- auto.arima(log(AirPassengers), xreg = xreg_train)
summary(modelo_dinamico)
```

**¿El modelo es válido? Análisis de los residuos**

COMPLETAR

```{r}
# Análisis completo de residuos
checkresiduals(modelo_dinamico)

# Graficos adicionales
par(mfrow = c(2, 2))
plot(residuals(modelo_dinamico), main = "Residuos del modelo")
hist(residuals(modelo_dinamico), main = "Histograma residuos", breaks = 20)
acf(residuals(modelo_dinamico), main = "ACF residuos")
pacf(residuals(modelo_dinamico), main = "PACF residuos")

# Test de Ljung-Box
Box.test(residuals(modelo_dinamico), lag = 24, type = "Ljung-Box")
```

**Predicciones de la serie estacionaria y de la serie original**

COMPLETAR

```{r}
# Crear variables exógenas para predicción
n <- length(log(AirPassengers))
xreg_futuro <- cbind(
  trend = (n + 1):(n + 36),
  fourier(log(AirPassengers), K = 6, h = 36)
)

# Predicciones en escala logarítmica
pred_dinamico <- forecast(modelo_dinamico, xreg = xreg_futuro, h = 36)

par(mfrow = c(1, 2))
# Serie log(AirPassengers)
plot(pred_dinamico, main = "Predicción log(AirPassengers)")

# Serie original AirPassengers
plot(AirPassengers,
  xlim = c(1949, 1964), ylim = c(100, 900),
  main = "Predicción AirPassengers", lwd = 2
)
lines(exp(pred_dinamico$mean), col = "blue", lwd = 2)
lines(exp(pred_dinamico$lower[, 2]), col = "blue", lty = 2)
lines(exp(pred_dinamico$upper[, 2]), col = "blue", lty = 2)
```

## 2.2. Ajuste de regresión y ajuste ARIMA por separado

COMPLETAR

```{r}
# Paso 1: Ajustar modelo de regresión
reg_modelo <- tslm(log(AirPassengers) ~ trend + season)
summary(reg_modelo)

# Paso 2: Obtener residuos de la regresión
residuos_reg <- residuals(reg_modelo)
plot(residuos_reg, main = "Residuos del modelo de regresión")
```

```{r}
# Paso 3: Ajustar modelo ARIMA a los residuos
arima_residuos <- auto.arima(residuos_reg)
summary(arima_residuos)

# Verificar residuos del ARIMA
checkresiduals(arima_residuos)
```

```{r}
# Paso 4: Predicciones combinadas
# Predicción de la parte de regresión
pred_reg <- forecast(reg_modelo, h = 36)

# Predicción de la parte ARIMA (residuos)
pred_arima_res <- forecast(arima_residuos, h = 36)

# Predicción combinada = regresión + ARIMA residuos
pred_combinada <- pred_reg$mean + pred_arima_res$mean

# Visualización
par(mfrow = c(1, 2))
plot(log(AirPassengers),
  xlim = c(1949, 1964), ylim = c(4.5, 7),
  main = "Predicción log(AirPassengers)", lwd = 2
)
lines(pred_reg$mean, col = "red", lty = 2) # Solo regresión
lines(pred_combinada, col = "blue", lwd = 2) # Regresión + ARIMA

plot(AirPassengers,
  xlim = c(1949, 1964), ylim = c(100, 900),
  main = "Predicción AirPassengers", lwd = 2
)
lines(exp(pred_combinada), col = "blue", lwd = 2)
legend("topleft",
  legend = c("Original", "Predicción"),
  col = c("black", "blue"), lwd = 2
)
```

```{r}
# Comparación de ambos métodos
par(mfrow = c(1, 1))
plot(AirPassengers,
  xlim = c(1949, 1964), ylim = c(100, 900),
  main = "Comparación de métodos de Regresión Dinámica", lwd = 2
)
lines(exp(pred_dinamico$mean), col = "red", lwd = 2) # Método conjunto
lines(exp(pred_combinada), col = "blue", lwd = 2) # Método separado
legend("topleft",
  legend = c("Original", "Conjunto (auto.arima+xreg)", "Separado (tslm+ARIMA)"),
  col = c("black", "red", "blue"), lwd = 2
)
```
