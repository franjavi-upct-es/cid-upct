---
title: "Procesos Estocásticos y Series Temporales"
subtitle: "Práctica 3: Métodos de Alisado Exponencial"
author: "Francisco Javier Mercader Martínez"
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=1.5cm, a4paper
header-includes:
- \renewcommand{\and}{\\}
- \usepackage{fvextra}
- \usepackage{hyperref}
- \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines, commandchars=\\\{\}}
---
# Problema 1

En el fichero **consumo_leche.txt** se encuentran los datos correspondientes al consumo de leche mensual (en miles de litros) por los habitantes de una determinada ciudad. Se dispone de datos sobre el consumo desde noviembre de 1992 hasta octubre de 2006.

1) Representa los datos del consumo de leche en un gráfico temporal y comenta los aspectos más relevantes. ¿La serie presenta Estacionalidad? ¿cómo dirías que es la tendencia?

```{r}
# Cargar los datos
datos <- read.table("consumo_leche.txt", header = TRUE)

# Convertir a serie temporal
# Los datos van desde noviembre de 1992 hasta octubre de 2006
# Son datos mensuales (frecuencia = 12)
consumo_leche_ts <- ts(datos$leche, start = c(1992, 11), frequency = 12)

# Representar gráfico temporal
ts.plot(consumo_leche_ts,
        gpars = list(xlab = "Año", ylab = "Consumo de leche (miles de litros)",
                     main = "Consumo mensual de leche",
                     lwd = 1.5))
```

2) Determina si se trata de un modelo aditivo o multiplicativo (realiza un gráfico de desviaciones típicas frente a medias para cada año).

```{r}
# Calcular medias y desviaciones típicas por año
anios <- floor(time(consumo_leche_ts))
medias_anuales <- tapply(consumo_leche_ts, anios, mean)
desv_anuales <- tapply(consumo_leche_ts, anios, sd)

# Gráfico de dispersión: desviaciones típicas vs medias
plot(medias_anuales, desv_anuales,
     xlab = "Media anual",
     ylab = "Desviación típica anual",
     main = "Relación entre media y desviación típica por año",
     pch = 19, col = "blue")

# Añadir línea de tendencia para visualizar la relación
abline(lm(desv_anuales ~ medias_anuales), col = "red", lwd = 2)
```

3) ¿Qué método de alisado exponencial sería más adecuado para la serie en estudio?.

Aunque la correlación de 0.59 podría sugerir cierta relación, el análisis determina que la desviación típica es relativamente constante, lo que indica un **modelo aditivo**.

4) Aplica dicho método de alisado exponencial a la serie, determina los parámetros de alisado óptimos e interprétalos. Indica los valores iniciales que usó R para nivel, pendiente de la tendencia y factores estacionales.

```{r}
modelo_hw_mult <- HoltWinters(consumo_leche_ts, seasonal = 'additive')
modelo_hw_mult
```

5) Con el método del apartado anterior, calcula los valores ajustados de la serie para los meses observados (168 meses) y realiza la predicción para los meses restantes de 2006 (noviembre y diciembre) y los dos años siguientes al completo (2007 y 2008). ¿Cuánto será el consumo de leche en noviembre de 2008?

```{r}
# Valores ajustados para los meses observados
valores_ajustados <- modelo_hw_mult$fitted[, 1]

# Predicción para los siguientes 26 meses
predicciones <- predict(modelo_hw_mult, n.ahead = 26)

# Mostrar las predicciones
predicciones

# Consumo previsto en noviembre de 2008
consumo_nov_2008 <- predicciones[26]
cat("\nConsumo previsto en noviembre de 2008:", consumo_nov_2008, "(miles de litros)")
```

6) Representa en un mismo gráfico la secuencia de la serie observada (en negro), la serie ajustada (en azul) y de la serie predicha (en rojo) con el modelo de alisado exponencial.

```{r}
ts.plot(consumo_leche_ts,
        gpars = list(xlab = "Año",
                     ylab = "Consumo de leche (miles de litros)",
                     lwd = 1.5))

# Añadir la serie ajustada en azul
lines(modelo_hw_mult$fitted[ , 1], col = "blue", lwd = 1.2)

# Añadir predicciones en rojo
lines(predicciones, col = "red", lwd = 1.2)

# Añadir leyenda
legend("topleft",
       legend = c("Serie observada", "Serie ajustada", "Predicciones"),
       col = c("black", "blue", "red"),
       lty = 1)
```

7) Proporciona las medidas de error MAE y RMSE del método de alisado para la serie observada. Compáralas con las obtenidas en Análisis Clásico y descomposición STL.

```{r}
# Calcular residuos del modelo Holt-Winters aditivo
residuos_hw <- consumo_leche_ts - valores_ajustados

# Calcular MAE (Mean Absolute Error)
MAE_hw <- mean(abs(residuos_hw), na.rm = TRUE)

# Calcular RMSE (Root Mean Square Error)
RMSE_hw <- sqrt(mean(residuos_hw^2, na.rm = TRUE))

cat("Medidas de error del método Holt-Winters aditivo:\n")
cat("MAE:", round(MAE_hw, 4), "\n")
cat("RMSE:", round(RMSE_hw, 4))
```

**Comparación esperada con otros métodos:**

- El método de Holt-Winters suele proporcionar mejores ajustes que el análisis clásico cuando hay patrones estacionales y tendencia bien definidos
- La descomposición STL es más robusta ante valores atípicos, por lo que podría tener errores similares o ligeramente menores
- Si los errores del Holt-Winters son menores, confirma que es un método adecuado para esta serie con componentes estacionales y tendencia claras

# PROBLEMA 2

Consideremos de nuevo los datos de consumo_leche.txt.

1) ¿Qué modelo ETS sería más adecuado para la serie en estudio?.

Ya que en el problema anterior se ha determinado que la serie presenta un comportamiento aditivo, un modelo ETS(A,A,A) podría ser adecuado para capturar tanto la tendencia como la estacionalidad de manera aditiva.

2) Aplica dicho modelo ETS a la serie, determina los parámetros de alisado óptimos e interprétalos. Indica los estados iniciales que usó R para nivel, pendiente de la tendencia y factores estacionales.

```{r, message = FALSE}
library(forecast)

# Aplicar el modelo ETS(A,A,A)
modelo_ets <- ets(consumo_leche_ts, model = "AAA")
modelo_ets
```

3) Ahora realiza la selección del modelo ETS de forma automática con R. ¿Se obtiene el mismo modelo que usaste en el apartado (2) o uno diferente?

```{r}
# Selección automática del modelo ETS
modelo_ets_auto <- ets(consumo_leche_ts)
modelo_ets_auto

# Comparar con el modelo especificado manualmente
cat("\n=== COMPARACIÓN DE MODELOS ===\n")
cat("Modelo especificado manualmente: ETS(A,A,A)\n")
cat("Modelo seleccionado automáticamente:", modelo_ets_auto$method, "\n\n")

# Comparar criterios de información
cat("=== CRITERIOS DE INFORMACIÓN ===\n")
cat("Modelo ETS(A,A,A):\n")
cat("  AIC:", modelo_ets$aic, "\n")
cat("  BIC:", modelo_ets$bic, "\n\n")

cat("Modelo automático:\n")
cat("  AIC:", modelo_ets_auto$aic, "\n")
cat("  BIC:", modelo_ets_auto$bic, "\n\n")

# Comparar errores
cat("=== COMPARACIÓN DE ERRORES ===\n")
cat("Modelo ETS(A,A,A) - Suma de cuadrados residuales:",
    sum(modelo_ets$residuals^2), "\n")
cat("Modelo automático - Suma de cuadrados residuales:",
    sum(modelo_ets_auto$residuals^2), "\n")

```

4) Con el modelo del apartado (2), calcula los valores ajustados de la serie para los meses observados (168 meses) y realiza la predicción para los meses restantes de 2006 (noviembre y diciembre) y los dos años siguientes al completo (2007 y 2008). ¿Cuánto será el consumo de leche en noviembre de 2008?

```{r}
# Valores ajustados del modelo ETS para los meses observados
valores_ajustados_ets <- modelo_ets$fitted

# Realizar predicciones para los siguientes 26 meses
# (2 meses de 2006 + 24 meses de 2007 y 2008)
predicciones_ets <- forecast(modelo_ets, h = 26)

# Mostrar las predicciones puntuales
cat("=== PREDICCIONES CON MODELO ETS(A,A,A) ===\n\n")
print(predicciones_ets)

# Consumo previsto en noviembre de 2008 (mes 26 de las predicciones)
consumo_nov_2008_ets <- predicciones_ets$mean[26]
cat("\n=== CONSUMO PREVISTO EN NOVIEMBRE DE 2008 ===\n")
cat("Consumo previsto:", round(consumo_nov_2008_ets, 2), "miles de litros\n")

# Comparación con el método Holt-Winters del Problema 1
cat("\n=== COMPARACIÓN CON HOLT-WINTERS ===\n")
cat("Holt-Winters aditivo:", round(consumo_nov_2008, 2), "miles de litros\n")
cat("ETS(A,A,A):", round(consumo_nov_2008_ets, 2), "miles de litros\n")
cat("Diferencia:", round(abs(consumo_nov_2008 - consumo_nov_2008_ets), 2),
    "miles de litros\n")

```

5) Determina los intervalos de predicción para el mismo tramo del apartado (4). Usa nivel de confianza del 90%.

```{r}
# Intervalos de predicción al 90% de confianza para los próximos 26 meses
predicciones_ets_90 <- forecast(modelo_ets, h = 26, level = 90)

# Mostrar predicciones con intervalos
cat("=== PREDICCIONES CON INTERVALOS AL 90% DE CONFIANZA ===\n\n")
print(predicciones_ets_90)

# Gráfico con intervalos de predicción
plot(predicciones_ets_90,
     main = "Predicciones del modelo ETS(A,A,A) con intervalos al 90%",
     xlab = "Año",
     ylab = "Consumo de leche (miles de litros)",
     shadecols = "lightblue")

# Añadir serie ajustada
lines(modelo_ets$fitted, col = "blue", lwd = 1.2)

# Añadir leyenda
legend("topleft",
       legend = c("Serie observada", "Serie ajustada", "Predicción", "IC 90%"),
       col = c("black", "blue", "blue", "lightblue"),
       lty = c(1, 1, 1, NA),
       fill = c(NA, NA, NA, "lightblue"),
       border = c(NA, NA, NA, "black"))

# Detalles del intervalo para noviembre de 2008
cat("\n=== INTERVALO DE PREDICCIÓN PARA NOVIEMBRE 2008 (90% confianza) ===\n")
cat("Predicción puntual:", round(predicciones_ets_90$mean[26], 2), "miles de litros\n")
cat("Límite inferior:", round(predicciones_ets_90$lower[26], 2), "miles de litros\n")
cat("Límite superior:", round(predicciones_ets_90$upper[26], 2), "miles de litros\n")
cat("Amplitud del intervalo:", round(predicciones_ets_90$upper[26] - predicciones_ets_90$lower[26], 2), "miles de litros\n")

```

6) ¿A qué se deben las diferencias de resultados entre el modelo ETS y el método de alisado exponencial?

Las diferencias entre el modelo ETS y el método de alisado exponencial (Holt-Winters) se deben principalmente a:

1. **Diferencias en la inicialización**
   - **Holt-Winters**: Utiliza valores iniciales basados en descomposición simple de la serie
   - **ETS**: Optimiza también los estados iniciales (nivel, tendencia y factores estacionales) como parámetros del modelo

   2. **Método de optimización**
   - **Holt-Winters**: Minimiza la suma de cuadrados residuales (SSE) usando un algoritmo más simple
   - **ETS**: Maximiza la verosimilitud logarítmica, lo que puede dar diferentes pesos a las observaciones

   3. **Criterios de ajuste**
   - **Holt-Winters**: Se centra únicamente en minimizar el error de ajuste
   - **ETS**: Además del ajuste, considera criterios de información (AIC, BIC) que penalizan la complejidad del modelo

   4. **Flexibilidad del modelo**
      - **Holt-Winters**: Parámetros de alisado fijos durante la estimación
      - **ETS**: Permite explorar diferentes estructuras de error y puede ajustar mejor los parámetros

```{r}
# Comparación numérica de las diferencias
cat("=== ANÁLISIS DE DIFERENCIAS ===\n\n")

# Parámetros de alisado
cat("Parámetros de alisado:\n")
cat("Holt-Winters - α:", modelo_hw_mult$alpha,
    ", β:", modelo_hw_mult$beta,
    ", γ:", modelo_hw_mult$gamma, "\n")
cat("ETS(A,A,A) - α:", modelo_ets$par["alpha"],
    ", β:", modelo_ets$par["beta"],
    ", γ:", modelo_ets$par["gamma"], "\n\n")

# Valores iniciales
cat("Estados iniciales:\n")
cat("Holt-Winters:\n")
cat("  Nivel inicial:", modelo_hw_mult$coefficients[1], "\n")
cat("  Tendencia inicial:", modelo_hw_mult$coefficients[2], "\n\n")

cat("ETS(A,A,A):\n")
cat("  Nivel inicial:", modelo_ets$states[1,"l"], "\n")
cat("  Tendencia inicial:", modelo_ets$states[1,"b"], "\n\n")

# Medidas de bondad de ajuste
cat("Bondad de ajuste:\n")
cat("Holt-Winters - SSE:", round(modelo_hw_mult$SSE, 2), "\n")
cat("ETS(A,A,A) - SSE:", round(sum(modelo_ets$residuals^2), 2), "\n")
cat("ETS(A,A,A) - AIC:", round(modelo_ets$aic, 2), "\n")
cat("ETS(A,A,A) - BIC:", round(modelo_ets$bic, 2), "\n\n")

# Correlación entre predicciones
correlacion_pred <- cor(predicciones, predicciones_ets$mean)
cat("Correlación entre predicciones:", round(correlacion_pred, 4), "\n")
```

  Aunque **Holt-Winters y ETS(A,A,A) son matemáticamente equivalentes** en su formulación, las diferencias en:

  - Los **métodos de estimación de parámetros**
  - La **inicialización de estados**
  - Los **criterios de optimización**

  pueden producir **ligeras diferencias** en los valores ajustados y predicciones. Sin embargo, estas diferencias suelen ser **pequeñas** y ambos modelos proporcionan resultados muy similares cuando se aplican a la misma serie temporal.